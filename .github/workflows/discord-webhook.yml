name: Discord Commit Notifier

on:
  push:
    branches: [ master ]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare commit data
        id: prepare
        run: |
          # Get basic commit info
          AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          
          # Get changed files (properly handle spaces and special chars)
          ADDED=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} | jq -R -s -c 'split("\n")[:-1]')
          MODIFIED=$(git diff --name-only --diff-filter=M ${{ github.event.before }} ${{ github.sha }} | jq -R -s -c 'split("\n")[:-1]')
          DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.sha }} | jq -R -s -c 'split("\n")[:-1]')
          
          # Output everything safely
          echo "AUTHOR=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "COMMIT_URL=${COMMIT_URL}" >> $GITHUB_OUTPUT
          echo "ADDED=${ADDED}" >> $GITHUB_OUTPUT
          echo "MODIFIED=${MODIFIED}" >> $GITHUB_OUTPUT
          echo "DELETED=${DELETED}" >> $GITHUB_OUTPUT

      - name: Create and send Discord message
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Load the prepared data
          AUTHOR="${{ steps.prepare.outputs.AUTHOR }}"
          COMMIT_URL="${{ steps.prepare.outputs.COMMIT_URL }}"
          ADDED="${{ steps.prepare.outputs.ADDED }}"
          MODIFIED="${{ steps.prepare.outputs.MODIFIED }}"
          DELETED="${{ steps.prepare.outputs.DELETED }}"
          
          # Initialize fields array
          FIELDS="[]"
          
          # Helper function to add fields
          add_field() {
            local name=$1
            local files=$2
            local count=$(echo "$files" | jq 'length')
            if [ "$count" -gt 0 ]; then
              FIELDS=$(echo "$FIELDS" | jq \
                --arg n "$name" \
                --arg v "$(echo "$files" | jq -r 'join("\n")')" \
                '. += [{"name": $n, "value": $v, "inline": false}]')
            fi
          }
          
          # Add fields for each change type
          add_field "üì• Added ($(echo "$ADDED" | jq 'length'))" "$ADDED"
          add_field "‚úèÔ∏è Modified ($(echo "$MODIFIED" | jq 'length'))" "$MODIFIED"
          add_field "üóëÔ∏è Removed ($(echo "$DELETED" | jq 'length'))" "$DELETED"
          
          # Create the final payload
          PAYLOAD=$(jq -n \
            --argjson fields "$FIELDS" \
            --arg author "$AUTHOR" \
            --arg url "$COMMIT_URL" \
            '{
              "embeds": [{
                "author": {"name": $author, "url": $url},
                "color": 5763719,
                "fields": $fields,
                "footer": {
                  "text": "GitHub",
                  "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                },
                "timestamp": now|strftime("%Y-%m-%dT%H:%M:%SZ")
              }]
            }')
          
          # Send to Discord using curl (more reliable than actions)
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK"
