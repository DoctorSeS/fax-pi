name: Discord Commit Notifier

on:
  push:
    branches: [ master ]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Required for proper diffing

      - name: Generate Discord payload
        id: generate-payload
        run: |
          # Install jq if not present
          sudo apt-get -qq install jq

          # Get commit info
          AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          
          # Get changed files as proper JSON arrays
          ADDED=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} | jq -R -s 'split("\n") | map(select(. != ""))')
          MODIFIED=$(git diff --name-only --diff-filter=M ${{ github.event.before }} ${{ github.sha }} | jq -R -s 'split("\n") | map(select(. != ""))')
          DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.sha }} | jq -R -s 'split("\n") | map(select(. != ""))')

          # Create fields array
          FIELDS=()
          
          # Helper function to add fields
          add_field() {
            local name=$1
            local files=$2
            local count=$(echo "$files" | jq 'length')
            if [ $count -gt 0 ]; then
              FIELDS+=("{\"name\":\"$name ($count)\",\"value\":\"$(echo "$files" | jq -r 'join("\\n")')\",\"inline\":false}")
            fi
          }
          
          # Add fields for each change type
          add_field "üì• Added" "$ADDED"
          add_field "‚úèÔ∏è Modified" "$MODIFIED"
          add_field "üóëÔ∏è Removed" "$DELETED"
          
          # Join fields with commas
          FIELDS_JSON=$(IFS=, ; echo "[${FIELDS[*]}]")
          
          # Create final payload
          PAYLOAD=$(jq -n \
            --arg author "$AUTHOR" \
            --arg url "$COMMIT_URL" \
            --argjson fields "$FIELDS_JSON" \
            '{
              "embeds": [{
                "author": {"name": $author, "url": $url},
                "color": 5763719,
                "fields": $fields,
                "footer": {
                  "text": "GitHub",
                  "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                },
                "timestamp": now|strftime("%Y-%m-%dT%H:%M:%SZ")
              }]
            }')
          
          # Save payload for debugging
          echo "$PAYLOAD" > payload.json
          echo "PAYLOAD=$(jq -c . < payload.json)" >> $GITHUB_OUTPUT

      - name: Debug payload
        run: |
          echo "Generated payload:"
          cat payload.json
          echo ""
          echo "Field counts:"
          echo "Added: $(jq '.embeds[0].fields | map(select(.name | startswith("üì•"))) | length' payload.json)"
          echo "Modified: $(jq '.embeds[0].fields | map(select(.name | startswith("‚úèÔ∏è"))) | length' payload.json)"
          echo "Removed: $(jq '.embeds[0].fields | map(select(.name | startswith("üóëÔ∏è"))) | length' payload.json)"

      - name: Send to Discord
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          embeds: ${{ steps.generate-payload.outputs.PAYLOAD }}
