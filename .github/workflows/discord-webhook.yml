name: Discord Commit Notifier

on:
  push:
    branches: [ master ]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate Discord payload
        id: generate-payload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Install dependencies
          sudo apt-get -qq install jq

          # Get commit info
          AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          
          # Get avatar URL using GitHub API with authentication
          AVATAR_URL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/users/$AUTHOR" | jq -r '.avatar_url + "?size=128"')
          
          # Get changed files
          ADDED=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} || echo "")
          MODIFIED=$(git diff --name-only --diff-filter=M ${{ github.event.before }} ${{ github.sha }} || echo "")
          DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.sha }} || echo "")

          # Format fields
          FIELDS=()
          
          add_field() {
            local name=$1
            local files=$2
            if [ -n "$files" ]; then
              count=$(echo "$files" | wc -w)
              formatted=$(echo "$files" | sed 's/ /\\n/g' | sed 's/^/â€¢ **/' | sed 's/$/**/')
              FIELDS+=("{\"name\":\"$name ($count)\",\"value\":\"$formatted\",\"inline\":false}")
            fi
          }
          
          add_field "Added" "$ADDED"
          add_field "Modified" "$MODIFIED"
          add_field "Removed" "$DELETED"
          
          # Join fields
          FIELDS_JSON=$(IFS=, ; echo "[${FIELDS[*]}]")

          # Create payload
          jq -n \
            --arg author "$AUTHOR" \
            --arg url "$COMMIT_URL" \
            --arg avatar "$AVATAR_URL" \
            --argjson fields "$FIELDS_JSON" \
            '{
              "username": "GitHub",
              "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "embeds": [{
                "author": {
                  "name": $author,
                  "url": $url,
                  "icon_url": $avatar
                },
                "color": 3447003,
                "fields": $fields,
                "footer": {
                  "text": "The Fax Machine",
                  "icon_url": "https://cdn.discordapp.com/avatars/830199512572100609/4b7402987cf65285260e0c16c12a7900.png"
                },
                "timestamp": now|strftime("%Y-%m-%dT%H:%M:%SZ")
              }]
            }' > payload.json

          # Debug output
          echo "Avatar URL used: $AVATAR_URL"
          echo "Payload content:"
          cat payload.json

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$DISCORD_WEBHOOK"
