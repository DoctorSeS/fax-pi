name: Discord Commit Notifier

on:
  push:
    branches: [ master ]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate Discord payload
        id: generate-payload
        run: |
          # Install jq if not present
          sudo apt-get -qq install jq

          # Get commit info
          AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          
          # Get changed files as arrays
          ADDED=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} | jq -R -s 'split("\n") | map(select(. != ""))')
          MODIFIED=$(git diff --name-only --diff-filter=M ${{ github.event.before }} ${{ github.sha }} | jq -R -s 'split("\n") | map(select(. != ""))')
          DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.sha }} | jq -R -s 'split("\n") | map(select(. != ""))')

          # Create fields array
          FIELDS="[]"
          
          # Helper function to add fields
          add_field() {
            local name=$1
            local files=$2
            local count=$(echo "$files" | jq 'length')
            if [ $count -gt 0 ]; then
              # Format files with bullet points and bold markers
              FORMATTED_FILES=$(echo "$files" | 
                jq -r '.[] | "â€¢ **\(.)**"' |  # Format each line
                tr '\n' '\f' |                 # Temporary replacement
                sed 's/\f/\n/g' |              # Convert to literal newlines
                jq -Rs . |                     # Convert to raw JSON string
                sed 's/^"//;s/"$//')           # Remove surrounding quotes
              
              FIELDS=$(echo "$FIELDS" | jq \
                --arg n "$name ($count)" \
                --arg v "$FORMATTED_FILES" \
                '. += [{"name": $n, "value": $v, "inline": false}]')
            fi
          }
                    
          # Add fields for each change type
          add_field "Added Files" "$ADDED"
          add_field "Updated Files" "$MODIFIED"
          add_field "Removed Files" "$DELETED"
          
          # Create final payload file
          jq -n \
            --arg author "$AUTHOR" \
            --arg url "$COMMIT_URL" \
            --arg avatar "${{ steps.get_avatar.outputs.AVATAR_URL }}" \
            --argjson fields "$FIELDS" \
            '{
              "username": "GitHub",
              "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "embeds": [{
                "author": {"name": $author, "icon_url": $avatar},
                "color": 3447003,
                "fields": $fields,
                "footer": {
                  "text": "The Fax Machine",
                  "icon_url": "https://cdn.discordapp.com/avatars/830199512572100609/4b7402987cf65285260e0c16c12a7900.png"
                },
                "timestamp": now|strftime("%Y-%m-%dT%H:%M:%SZ")
              }]
            }' > payload.json

          # Verify payload is valid JSON
          if ! jq empty payload.json; then
            echo "Error: Invalid JSON payload"
            exit 1
          fi

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Send using file reference to avoid shell escaping issues
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$DISCORD_WEBHOOK"
