name: Discord Commit Notifier

on:
  push:
    branches: [ master ]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare commit data
        id: prepare
        run: |
          # Escape JSON special characters in commit message
          COMMIT_MSG=$(git log -1 --pretty=%B | jq -Rs . | sed 's/^"//;s/"$//')
          echo "COMMIT_MESSAGE=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "AUTHOR=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "COMMIT_URL=https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA" >> $GITHUB_OUTPUT
          
          # Get changed files (handle empty cases)
          ADDED=$(git diff --name-only --diff-filter=A HEAD~1 HEAD || echo "None")
          MODIFIED=$(git diff --name-only --diff-filter=M HEAD~1 HEAD || echo "None")
          DELETED=$(git diff --name-only --diff-filter=D HEAD~1 HEAD || echo "None")
          
          # Format with newlines
          echo "ADDED_FILES=$(echo "$ADDED" | sed 's/ /\\n/g')" >> $GITHUB_OUTPUT
          echo "MODIFIED_FILES=$(echo "$MODIFIED" | sed 's/ /\\n/g')" >> $GITHUB_OUTPUT
          echo "DELETED_FILES=$(echo "$DELETED" | sed 's/ /\\n/g')" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          embeds: |
            [
              {
                "title": "New Commit Pushed",
                "url": "${{ steps.prepare.outputs.COMMIT_URL }}",
                "color": 3447003,
                "fields": [
                  {
                    "name": "Author",
                    "value": "${{ steps.prepare.outputs.AUTHOR }}",
                    "inline": true
                  },
                  {
                    "name": "Message",
                    "value": "${{ steps.prepare.outputs.COMMIT_MESSAGE }}",
                    "inline": false
                  },
                  {
                    "name": "Added Files ($(echo "${{ steps.prepare.outputs.ADDED_FILES }}" | grep -c '\\n' || echo 0)",
                    "value": "${{ steps.prepare.outputs.ADDED_FILES }}",
                    "inline": false
                  },
                  {
                    "name": "Modified Files ($(echo "${{ steps.prepare.outputs.MODIFIED_FILES }}" | grep -c '\\n' || echo 0)",
                    "value": "${{ steps.prepare.outputs.MODIFIED_FILES }}",
                    "inline": false
                  },
                  {
                    "name": "Deleted Files ($(echo "${{ steps.prepare.outputs.DELETED_FILES }}" | grep -c '\\n' || echo 0)",
                    "value": "${{ steps.prepare.outputs.DELETED_FILES }}",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "GitHub Actions",
                  "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                },
                "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
              }
            ]
