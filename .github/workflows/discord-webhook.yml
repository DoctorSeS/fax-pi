name: Discord Commit Notifier

on:
  push:
    branches: [ master ]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for proper diff

      - name: Analyze changes
        id: changes
        run: |
          # Get proper diff between commits
          echo "ADDED=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} | grep . || echo '')" >> $GITHUB_OUTPUT
          echo "MODIFIED=$(git diff --name-only --diff-filter=M ${{ github.event.before }} ${{ github.sha }} | grep . || echo '')" >> $GITHUB_OUTPUT
          echo "DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.sha }} | grep . || echo '')" >> $GITHUB_OUTPUT

      - name: Prepare Discord message
        id: discord
        run: |
          # Count changes
          ADDED_COUNT=$(echo "${{ steps.changes.outputs.ADDED }}" | wc -w | tr -d ' ')
          MODIFIED_COUNT=$(echo "${{ steps.changes.outputs.MODIFIED }}" | wc -w | tr -d ' ')
          DELETED_COUNT=$(echo "${{ steps.changes.outputs.DELETED }}" | wc -w | tr -d ' ')

          # Format file lists
          ADDED_FILES=$(echo "${{ steps.changes.outputs.ADDED }}" | sed 's/ /\\n/g')
          MODIFIED_FILES=$(echo "${{ steps.changes.outputs.MODIFIED }}" | sed 's/ /\\n/g')
          DELETED_FILES=$(echo "${{ steps.changes.outputs.DELETED }}" | sed 's/ /\\n/g')

          # Build fields array
          FIELDS="[]"
          
          if [ "$ADDED_COUNT" -gt 0 ]; then
            FIELDS=$(echo "$FIELDS" | jq --arg files "$ADDED_FILES" \
              '. += [{"name": "📥 Added ($ADDED_COUNT)", "value": $files, "inline": false}]')
          fi
          
          if [ "$MODIFIED_COUNT" -gt 0 ]; then
            FIELDS=$(echo "$FIELDS" | jq --arg files "$MODIFIED_FILES" \
              '. += [{"name": "✏️ Modified ($MODIFIED_COUNT)", "value": $files, "inline": false}]')
          fi
          
          if [ "$DELETED_COUNT" -gt 0 ]; then
            FIELDS=$(echo "$FIELDS" | jq --arg files "$DELETED_FILES" \
              '. += [{"name": "🗑️ Removed ($DELETED_COUNT)", "value": $files, "inline": false}]')
          fi

          # Create final payload
          echo "PAYLOAD=$(jq -n \
            --argjson fields "$FIELDS" \
            --arg author "$(git log -1 --pretty=%an)" \
            --arg url "https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA" \
            '{
              "embeds": [{
                "author": {"name": $author},
                "url": $url,
                "color": 5763719,
                "fields": $fields,
                "footer": {
                  "text": "GitHub",
                  "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                },
                "timestamp": now|strftime("%Y-%m-%dT%H:%M:%SZ")
              }]
            }')" >> $GITHUB_OUTPUT

      - name: Send to Discord
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          embeds: ${{ steps.discord.outputs.PAYLOAD }}
